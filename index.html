<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Campus Sound Map</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      background: #f5f5f5;
    }
    header { 
      padding: 16px 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff; 
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    header h1 { margin: 0; font-size: 24px; font-weight: 600; }
    header p { margin: 4px 0 0 0; opacity: 0.9; font-size: 14px; }
    .wrap { padding: 16px; max-width: 900px; margin: 0 auto; }
    #map { height: 400px; width: 100%; background: #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .card { margin-top: 16px; padding: 20px; border: none; border-radius: 12px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card h2 { margin: 0 0 12px 0; font-size: 20px; color: #333; }
    button { font-size: 16px; padding: 12px 20px; border-radius: 8px; border: none; background: #667eea; color: #fff; cursor: pointer; font-weight: 500; transition: all 0.2s; width: 100%; }
    button:hover { background: #5568d3; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    input, textarea { width: 100%; padding: 12px 14px; margin: 8px 0; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; font-family: inherit; transition: border-color 0.2s; }
    input:focus, textarea:focus { outline: none; border-color: #667eea; }
    .hint { color: #666; font-size: 14px; margin: 8px 0; }
    .status { padding: 10px 14px; border-radius: 8px; margin-top: 12px; font-size: 14px; }
    .ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .err { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    label { display: block; font-weight: 500; color: #333; margin-top: 12px; margin-bottom: 4px; }
    .emoji { font-size: 20px; margin-right: 8px; }
    @media (max-width: 600px) { #map { height: 300px; } .wrap { padding: 12px; } header h1 { font-size: 20px; } }
  </style>
</head>
<body>
  <header>
    <h1>üéµ Campus Sound Map</h1>
    <p>Share the songs that soundtrack your campus moments</p>
  </header>
  <div class="wrap">
    <div id="map"></div>
    <div class="card">
      <h2>üìç Add Your Song</h2>
      <p class="hint">Capture your current location, add your song link, and share the vibe!</p>
      <button id="locBtn"><span class="emoji">üìç</span>Capture My Location</button>
      <div id="locStatus" class="hint"></div>
      <label for="songURL"><span class="emoji">üîó</span>Song Link (required)</label>
      <input id="songURL" type="url" placeholder="Paste Spotify, YouTube, or Apple Music link"/>
      <label for="songTitle"><span class="emoji">üéµ</span>Song Title (optional)</label>
      <input id="songTitle" placeholder="e.g., Bohemian Rhapsody - Queen"/>
      <label for="note"><span class="emoji">üí≠</span>Your Moment (optional)</label>
      <textarea id="note" rows="2" placeholder="What were you feeling? What were you doing?"></textarea>
      <label for="submittedBy"><span class="emoji">‚úçÔ∏è</span>Your Name (optional)</label>
      <input id="submittedBy" placeholder="e.g., Priya, Anonymous"/>
      <button id="submitBtn" disabled><span class="emoji">üöÄ</span>Submit to Map</button>
      <div id="submitMsg"></div>
    </div>
    <div class="card">
      <h2>‚ÑπÔ∏è How It Works</h2>
      <p class="hint">
        1. Click "Capture My Location" and allow location access<br>
        2. Paste the link to the song you're listening to<br>
        3. Optionally add song title, your thoughts, and name<br>
        4. Hit Submit and your song will appear on the map!<br><br>
        Refresh the page to see new songs added by others.
      </p>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const GOOGLE_FORM_ID = "14_HXP-DeGvHzpNqh713fEJ_XizfrmJYLe6LDbXtRasI";  // From forms.google.com/forms/d/YOUR_ID/edit
    const MAPS_API_KEY = "AIzaSyDe9axMQf7lMM-bbyz_1eputGtTs8T407s";
    const CAMPUS_CENTER = { lat: 23.038353588361236, lng: 72.55432705212638 };

    // Field mapping (from your Google Form field IDs)
    const FORM_FIELDS = {
      latitude: "entry.723196950",      // Replace with actual entry ID
      longitude: "entry.1352462261",
      songURL: "entry.1672374478",
      songTitle: "entry.1407249616",
      note: "entry.138660495",
      submittedBy: "entry.350025698"
    };

    let map, userMarker, currentPos = null;

    async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      window.AdvancedMarkerElement = AdvancedMarkerElement;
      map = new Map(document.getElementById("map"), {
        zoom: 17,
        center: CAMPUS_CENTER,
        mapId: "DEMO_MAP_ID",
      });
      loadExistingMarkers();
    }

    async function loadExistingMarkers() {
      // For Google Forms, we read from localStorage (local-only approach)
      // In production, you'd fetch from a Google Sheet that the form populates
      try {
        const stored = localStorage.getItem("campusSoundMarkers");
        const markers = stored ? JSON.parse(stored) : [];
        markers.forEach(item => {
          if (!item.lat || !item.lng) return;
          const pos = { lat: Number(item.lat), lng: Number(item.lng) };
          addMarkerToMap(pos, item);
        });
      } catch (e) { console.warn("Failed to load markers", e); }
    }

    async function addMarkerToMap(pos, item) {
      const marker = new window.AdvancedMarkerElement({ 
        map, 
        position: pos, 
        title: item.songTitle || "Song" 
      });
      const info = new google.maps.InfoWindow({
        content: `
          <div style="max-width:250px; padding:8px;">
            <div style="font-weight:600; font-size:16px; margin-bottom:8px; color:#333;">
              ${escapeHtml(item.songTitle || 'Untitled Song')}
            </div>
            ${item.songURL ? `<a href="${escapeAttr(item.songURL)}" target="_blank" rel="noopener" style="color:#667eea;font-weight:500;">üéß Listen Now</a>` : ''}
            ${item.note ? `<div style="margin-top:8px; color:#555; font-size:14px; font-style:italic;">"${escapeHtml(item.note)}"</div>` : ''}
            ${item.submittedBy ? `<div style="margin-top:8px; font-size:12px; color:#777;">‚Äì ${escapeHtml(item.submittedBy)}</div>` : ''}
          </div>
        `
      });
      marker.addListener("click", () => info.open({ anchor: marker, map }));
    }

    function escapeHtml(s) { return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s) { return String(s||'').replace(/\"/g, '&quot;'); }

    function getLocation() {
      const status = document.getElementById("locStatus");
      const btn = document.getElementById("locBtn");
      const submitBtn = document.getElementById("submitBtn");
      status.innerHTML = '<div class="status" style="background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb;">üì° Requesting your location...</div>';
      btn.disabled = true;
      
      if (!navigator.geolocation) { 
        status.innerHTML = '<div class="status err">‚ùå Geolocation not supported.</div>'; 
        btn.disabled = false; 
        return; 
      }
      
      navigator.geolocation.getCurrentPosition(pos => {
        currentPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        status.innerHTML = `<div class="status ok">‚úÖ Location captured! (${currentPos.lat.toFixed(5)}, ${currentPos.lng.toFixed(5)})</div>`;
        btn.disabled = false; 
        submitBtn.disabled = false; 
        dropUserMarker();
      }, err => { 
        status.innerHTML = '<div class="status err">‚ùå Location access denied. Please enable location permissions.</div>'; 
        btn.disabled = false; 
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
    }

    async function dropUserMarker() {
      if (!currentPos) return;
      map.setCenter(currentPos); 
      map.setZoom(18);
      if (userMarker) userMarker.map = null;
      const userPin = document.createElement('div'); 
      userPin.innerHTML = 'üìç'; 
      userPin.style.fontSize = '32px';
      userMarker = new window.AdvancedMarkerElement({ map, position: currentPos, title: "You are here", content: userPin });
    }

    async function submitData() {
      const msg = document.getElementById("submitMsg");
      const submitBtn = document.getElementById("submitBtn");
      msg.innerHTML = "";
      
      if (!currentPos) { 
        msg.innerHTML = '<div class="status err">‚ùå Please capture location first.</div>'; 
        return; 
      }
      
      const songURL = document.getElementById("songURL").value.trim();
      if (!songURL) { 
        msg.innerHTML = '<div class="status err">‚ùå Song URL is required.</div>'; 
        return; 
      }
      
      try { new URL(songURL); } 
      catch { 
        msg.innerHTML = '<div class="status err">‚ùå Invalid URL.</div>'; 
        return; 
      }
      
      const formData = new FormData();
      formData.append(FORM_FIELDS.latitude, currentPos.lat);
      formData.append(FORM_FIELDS.longitude, currentPos.lng);
      formData.append(FORM_FIELDS.songURL, songURL);
      formData.append(FORM_FIELDS.songTitle, document.getElementById("songTitle").value.trim());
      formData.append(FORM_FIELDS.note, document.getElementById("note").value.trim());
      formData.append(FORM_FIELDS.submittedBy, document.getElementById("submittedBy").value.trim());
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="emoji">‚è≥</span>Submitting...';
      
      try {
        const url = `https://docs.google.com/forms/d/${GOOGLE_FORM_ID}/formResponse`;
        await fetch(url, {
          method: 'POST',
          body: formData,
          mode: 'no-cors'
        });
        
        // Store locally for immediate display
        const item = {
          lat: currentPos.lat,
          lng: currentPos.lng,
          songURL,
          songTitle: document.getElementById("songTitle").value.trim(),
          note: document.getElementById("note").value.trim(),
          submittedBy: document.getElementById("submittedBy").value.trim()
        };
        const stored = localStorage.getItem("campusSoundMarkers");
        const markers = stored ? JSON.parse(stored) : [];
        markers.push(item);
        localStorage.setItem("campusSoundMarkers", JSON.stringify(markers));
        
        msg.innerHTML = '<div class="status ok">‚úÖ Song added! Refresh to see all markers.</div>';
        document.getElementById("songTitle").value = "";
        document.getElementById("songURL").value = "";
        document.getElementById("note").value = "";
        document.getElementById("submittedBy").value = "";
        
        // Add to map immediately
        addMarkerToMap(currentPos, item);
      } catch (e) {
        msg.innerHTML = '<div class="status err">‚ùå Failed to save. Try again.</div>';
        console.error('Error:', e);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="emoji">üöÄ</span>Submit to Map';
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("locBtn").addEventListener("click", getLocation);
      document.getElementById("submitBtn").addEventListener("click", submitData);
    });

    // Load Google Maps
    (function() {
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${MAPS_API_KEY}&callback=initMap&libraries=marker`;
      script.async = true;
      document.head.appendChild(script);
      window.initMap = initMap;
    })();
  </script>
</body>
</html>
